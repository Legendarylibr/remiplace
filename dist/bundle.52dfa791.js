var a={APP_NAME:"(r) EMI / Place",USE_BACKEND:!0,FALLBACK_TO_LOCAL:!0,OPEN_MODE:!1,ALLOWED_CHAINS:[{chainId:1,chainIdHex:"0x1",name:"Ethereum"},{chainId:8453,chainIdHex:"0x2105",name:"Base"},{chainId:42161,chainIdHex:"0xa4b1",name:"Arbitrum"},{chainId:10,chainIdHex:"0xa",name:"Optimism"},{chainId:137,chainIdHex:"0x89",name:"Polygon"},{chainId:324,chainIdHex:"0x144",name:"zkSync Era"}],CANVAS:{width:220,height:150,displayScale:4},PALETTE:["#ff0000","#ff7f00","#ffff00","#00ff00","#0000ff","#4b0082","#9400d3","#000000","#ffffff"],STORAGE_KEY:"romelia_house_canvas"},A=location.hostname==="localhost"||location.hostname==="127.0.0.1";var b=o=>o?`${o.slice(0,6)}...${o.slice(-4)}`:"",L=o=>/^#[0-9A-Fa-f]{6}$/.test(o);function f(o){let t=typeof o=="string"?parseInt(o,o.startsWith("0x")?16:10):o;return a.ALLOWED_CHAINS.find(e=>e.chainId===t)}var w=o=>!!f(o),d={debug:(o,...t)=>A&&console.log(`[${o}]`,...t),info:(o,...t)=>A&&console.info(`[${o}]`,...t),warn:(o,...t)=>console.warn(`[${o}]`,...t),error:(o,...t)=>console.error(`[${o}]`,...t)};var B="/api",v=null;function T(o){v=o,o?localStorage.setItem("romelia_token",o):localStorage.removeItem("romelia_token")}function _(){return v||(v=localStorage.getItem("romelia_token")),v}function m(){v=null,localStorage.removeItem("romelia_token")}async function g(o,t={}){let e=_(),s={"Content-Type":"application/json",...t.headers};e&&(s.Authorization=`Bearer ${e}`);let i=await fetch(`${B}${o}`,{...t,headers:s});if(i.status===401){let n=await i.json();throw n.code==="TOKEN_EXPIRED"&&(m(),window.dispatchEvent(new CustomEvent("auth:expired"))),new Error(n.error||"Authentication required")}if(!i.ok){let n=await i.json().catch(()=>({}));throw new Error(n.error||`HTTP ${i.status}`)}return i.json()}var y={async connect(o,t){let e=await g("/auth/connect",{method:"POST",body:JSON.stringify({address:o,chainId:t})});return e.token&&T(e.token),e},async refresh(o){let t=await g("/auth/refresh",{method:"POST",body:JSON.stringify({chainId:o})});return t.token&&T(t.token),t},verify:()=>g("/auth/verify"),logout:()=>m()},C={getCanvas:()=>g("/canvas"),getConfig:()=>g("/canvas/config")};var S=class{constructor(){this.ws=null,this.listeners={},this.reconnectDelay=500,this.maxReconnectDelay=1e4,this.userAddress=null,this.authToken=null,this.pendingPixels=[],this.authenticated=!1,this.openMode=!1,this.pingInterval=null,this.connectionCheckInterval=null,this.lastPongTime=Date.now(),this.missedPongs=0,this.maxMissedPongs=3,this.isReconnecting=!1,this._setupVisibilityHandler(),this._setupNetworkHandler()}_setupVisibilityHandler(){typeof document>"u"||document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&(this.isConnected()?this._sendPing():(d.info("WS","Tab visible, reconnecting..."),this.reconnect()))})}_setupNetworkHandler(){typeof window>"u"||(window.addEventListener("online",()=>{d.info("WS","Network online, reconnecting..."),this.reconnectDelay=500,this.reconnect()}),window.addEventListener("offline",()=>{d.warn("WS","Network offline"),this._emit("disconnected")}))}setAddress(t){this.userAddress=t}setOpenMode(t){this.openMode=t}setToken(t){let e=!!this.authToken;if(this.authToken=t,t&&!e&&this.ws){let s=this.ws.readyState;(s===WebSocket.OPEN||s===WebSocket.CONNECTING)&&this.reconnect()}}reconnect(){this.isReconnecting||(this.isReconnecting=!0,this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.close(),this.ws=null),this._stopTimers(),setTimeout(()=>{this.isReconnecting=!1,this.connect()},100))}connect(){if(this.ws?.readyState===WebSocket.OPEN||this.ws?.readyState===WebSocket.CONNECTING)return;let e=`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/ws`;this.authToken&&(e+=`?token=${encodeURIComponent(this.authToken)}`),d.info("WS","Connecting..."),this.ws=new WebSocket(e),this.ws.onopen=()=>{d.info("WS","Connected"),this.reconnectDelay=500,this.authenticated=!!this.authToken,this.lastPongTime=Date.now(),this.missedPongs=0,this._startTimers(),this._emit("connected"),this._flushPending()},this.ws.onmessage=s=>{try{let{type:i,data:n}=JSON.parse(s.data);this._handleMessage(i,n)}catch(i){d.error("WS","Parse error:",i)}},this.ws.onclose=s=>{this._stopTimers(),this._emit("disconnected"),s.code!==1e3&&(d.warn("WS",`Disconnected (code: ${s.code}), reconnecting in ${this.reconnectDelay}ms...`),setTimeout(()=>this.connect(),this.reconnectDelay),this.reconnectDelay=Math.min(this.reconnectDelay*1.5,this.maxReconnectDelay))},this.ws.onerror=s=>{d.error("WS","Connection error")}}_handleMessage(t,e){if(t==="welcome"&&e.status)this._emit("status",e.status);else if(t==="pong"){this.lastPongTime=Date.now(),this.missedPongs=0;return}else this._emit(t,e)}_sendPing(){this.ws?.readyState===WebSocket.OPEN&&this._send("ping",{ts:Date.now()})}_startTimers(){this._stopTimers(),this.pingInterval=setInterval(()=>{this._sendPing()},15e3),this.connectionCheckInterval=setInterval(()=>{this._checkConnectionHealth()},1e4)}_checkConnectionHealth(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let t=Date.now()-this.lastPongTime;t>45e3&&(this.missedPongs++,d.warn("WS",`No pong received for ${Math.round(t/1e3)}s (missed: ${this.missedPongs})`),this.missedPongs>=this.maxMissedPongs&&(d.error("WS","Connection appears dead, forcing reconnect"),this.reconnect()))}_stopTimers(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null),this.connectionCheckInterval&&(clearInterval(this.connectionCheckInterval),this.connectionCheckInterval=null)}_canSend(){return this.ws?.readyState===WebSocket.OPEN&&(this.authenticated||this.openMode)}sendPixel(t,e,s){this._canSend()?this._send("pixel",{x:t,y:e,color:s,address:this.userAddress}):this.pendingPixels.push({x:t,y:e,color:s})}_flushPending(){if(!(!this.pendingPixels.length||!this.authenticated&&!this.openMode)){if(this.pendingPixels.length>1)this._send("batch",{pixels:this.pendingPixels,address:this.userAddress});else{let t=this.pendingPixels[0];this._send("pixel",{...t,address:this.userAddress})}this.pendingPixels=[]}}_send(t,e){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:t,data:e}))}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}_emit(t,e){(this.listeners[t]||[]).forEach(s=>s(e))}isConnected(){return this.ws?.readyState===WebSocket.OPEN}disconnect(){this._stopTimers(),this.authenticated=!1,this.pendingPixels=[],this.ws&&(this.ws.onclose=null,this.ws.close(1e3,"Client disconnect"),this.ws=null)}},r=new S;var E=class{constructor(){this.provider=null,this.signer=null,this.address=null,this.chainId=null,this.wallets=[],this.onAccountChange=null,this.onChainChange=null,this.onConnect=null,this.onDisconnect=null,this._seenProviders=new Set,this._activeProvider=null,this._initEIP6963()}_initEIP6963(){window.addEventListener("eip6963:announceProvider",t=>{let{info:e,provider:s}=t.detail,i=e.rdns||e.uuid;this._seenProviders.has(i)||(this._seenProviders.add(i),this.wallets.push({info:{...e,uuid:i},provider:s}))}),window.dispatchEvent(new Event("eip6963:requestProvider")),this._addLegacyWallets(),setTimeout(()=>this._addLegacyWallets(),500)}refreshWallets(){window.dispatchEvent(new Event("eip6963:requestProvider")),this._addLegacyWallets()}_addLegacyWallets(){let t=new Set(this.wallets.map(e=>e.info.name.toLowerCase()));if(window.ethereum?.providers&&window.ethereum.providers.forEach((e,s)=>{if(!e)return;let i=this._identify(e),n=`legacy-${s}`;!t.has(i.name.toLowerCase())&&!this._seenProviders.has(n)&&(this._seenProviders.add(n),this.wallets.push({info:{...i,uuid:n},provider:e}),t.add(i.name.toLowerCase()))}),window.ethereum&&!this._seenProviders.has("legacy-main")){let e=this._identify(window.ethereum);t.has(e.name.toLowerCase())||(this._seenProviders.add("legacy-main"),this.wallets.push({info:{...e,uuid:"legacy-main"},provider:window.ethereum}))}}_identify(t){let e=[[()=>t.isMetaMask&&!t.isRabby&&!t.isBraveWallet,"MetaMask","#F6851B"],[()=>t.isRabby,"Rabby Wallet","#8697FF"],[()=>t.isCoinbaseWallet||t.isCoinbaseBrowser,"Coinbase Wallet","#0052FF"],[()=>t.isPhantom,"Phantom","#AB9FF2"],[()=>t.isTrust||t.isTrustWallet,"Trust Wallet","#0500FF"],[()=>t.isRainbow,"Rainbow","#174299"],[()=>t.isBraveWallet,"Brave Wallet","#FB542B"],[()=>t.isFrame,"Frame","#1A1A1A"]];for(let[s,i,n]of e)if(s())return{name:i,icon:this._icon(n)};return{name:"Browser Wallet",icon:this._icon("#333")}}_icon(t){return`data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><rect fill="${encodeURIComponent(t)}" width="32" height="32" rx="6"/></svg>`}getAvailableWallets(){return this.wallets.map(t=>({name:t.info.name,uuid:t.info.uuid,icon:t.info.icon}))}async connect(t=null){let e=t?this.wallets.find(i=>i.info.uuid===t):this.wallets[0];if(!e)throw new Error("No wallet detected");let s=e.provider;if(!s)throw new Error(`${e.info.name} not available`);try{let i=await s.request({method:"eth_requestAccounts"});if(!i?.length)throw new Error("No accounts returned");let{ethers:n}=await import("https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js");this.provider=new n.BrowserProvider(s),this.signer=await this.provider.getSigner(),this.address=i[0],this._activeProvider=s;let l=await this.provider.getNetwork();return this.chainId=Number(l.chainId),this._setupListeners(s),this.onConnect?.(this.address,this.chainId),{address:this.address,chainId:this.chainId}}catch(i){throw i.code===4001?new Error("Connection rejected"):i}}_setupListeners(t){t.on("accountsChanged",e=>{e.length?(this.address=e[0],this.onAccountChange?.(this.address)):this.disconnect()}),t.on("chainChanged",e=>{this.chainId=parseInt(e,16),this.onChainChange?.(this.chainId)}),t.on("disconnect",()=>this.disconnect())}async disconnect(){this.provider=this.signer=this.address=this.chainId=null,m(),this.onDisconnect?.()}async switchNetwork(t){let e=f(t);if(!e)throw new Error("Chain not allowed");let s=this._activeProvider||window.ethereum;if(!s)throw new Error("No provider");try{await s.request({method:"wallet_switchEthereumChain",params:[{chainId:e.chainIdHex}]})}catch(i){if(i.code===4902)await s.request({method:"wallet_addEthereumChain",params:[{chainId:e.chainIdHex,chainName:e.name,nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},rpcUrls:[],blockExplorerUrls:[]}]});else throw i}}async signMessage(t){if(!this.signer)throw new Error("No signer available");return this.signer.signMessage(t)}async tryRehydrate(){let t=window.ethereum||this.wallets[0]?.provider;if(!t)return!1;try{let e=await t.request({method:"eth_accounts"});if(e?.length){let{ethers:s}=await import("https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js");this.provider=new s.BrowserProvider(t),this.signer=await this.provider.getSigner(),this.address=e[0];let i=await this.provider.getNetwork();return this.chainId=Number(i.chainId),this._setupListeners(t),this.onConnect?.(this.address,this.chainId),!0}}catch{}return!1}isConnected(){return this.address&&this.provider}};var P=class{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.gridWidth=e.width,this.gridHeight=e.height,this.pixelSize=e.displayScale,t.width=this.gridWidth*this.pixelSize,t.height=this.gridHeight*this.pixelSize,this.pixels=this._createGrid(),this.selectedColor=a.PALETTE[0],this.isAuthorized=!1,this.eraserMode=!1,this.onPixelPlace=null,this.onCursorMove=null,this.onZoomChange=null,this.zoom=1,this.minZoom=.5,this.maxZoom=8,this.panX=0,this.panY=0,this.isPanning=!1,this.lastPanPoint=null,this._updateMaxZoomForScreen(),this.hoverX=null,this.hoverY=null,this._setupEvents(),this._setupZoom(),this._setupContainerZoomIsolation(),this._setupResizeHandler(),this._render()}_createGrid(){return Array(this.gridHeight).fill(null).map(()=>Array(this.gridWidth).fill(null))}_setupEvents(){let t=(s,i)=>{if(s<0||s>=this.gridWidth||i<0||i>=this.gridHeight)return;let n=this.eraserMode?null:this.selectedColor;this.pixels[i][s]=n,this._renderPixel(s,i,n),this.onPixelPlace?.(s,i,n)},e=s=>{let i=this.canvas.getBoundingClientRect(),n=getComputedStyle(this.canvas),l=parseFloat(n.borderLeftWidth)||0,h=parseFloat(n.borderTopWidth)||0,c=i.width-l-(parseFloat(n.borderRightWidth)||0),u=i.height-h-(parseFloat(n.borderBottomWidth)||0);if(c<=0||u<=0)return{x:0,y:0};let p=(s.clientX-i.left-l)/c*this.gridWidth,x=(s.clientY-i.top-h)/u*this.gridHeight;return{x:Math.max(0,Math.min(this.gridWidth-1,Math.floor(p))),y:Math.max(0,Math.min(this.gridHeight-1,Math.floor(x)))}};this.canvas.addEventListener("click",s=>{if(!this.isAuthorized||this._justPanned)return;s.preventDefault();let{x:i,y:n}=e(s);this._clearHoverPreview(),t(i,n),this._updateHoverPreview(i,n)}),this.canvas.addEventListener("pointermove",s=>{if(this.isPanning&&this.lastPanPoint){let l=s.clientX-this.lastPanPoint.x,h=s.clientY-this.lastPanPoint.y;this.panX+=l,this.panY+=h,this.lastPanPoint={x:s.clientX,y:s.clientY},this._applyTransform();return}let{x:i,y:n}=e(s);this._updateHoverPreview(i,n),this.onCursorMove?.(i,n)}),this.canvas.addEventListener("pointerleave",()=>{this._clearHoverPreview(),this.onCursorMove?.(null,null)}),this.canvas.addEventListener("pointerdown",s=>{(s.button===1||s.button===0&&s.altKey)&&(s.preventDefault(),this.isPanning=!0,this._justPanned=!1,this.lastPanPoint={x:s.clientX,y:s.clientY},this.canvas.style.cursor="grabbing")}),window.addEventListener("pointerup",s=>{if(this.isPanning){if(this.lastPanPoint){let i=Math.abs(s.clientX-this.lastPanPoint.x),n=Math.abs(s.clientY-this.lastPanPoint.y);(i>3||n>3)&&(this._justPanned=!0),setTimeout(()=>this._justPanned=!1,100)}this.isPanning=!1,this.lastPanPoint=null,this.canvas.style.cursor=this.isAuthorized?"crosshair":"not-allowed"}})}_setupZoom(){this.canvas.addEventListener("wheel",s=>{s.preventDefault();let i=this.canvas.getBoundingClientRect(),n=s.clientX-i.left,l=s.clientY-i.top,h=s.deltaY>0?.9:1.1,c=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*h));if(c!==this.zoom){let u=c/this.zoom;this.panX=n-(n-this.panX)*u,this.panY=l-(l-this.panY)*u,this.zoom=c,this._applyTransform()}},{passive:!1}),this.canvas.addEventListener("dblclick",s=>{(this.zoom!==1||this.panX!==0||this.panY!==0)&&(s.preventDefault(),this.zoom=1,this.panX=0,this.panY=0,this._applyTransform())});let t=0,e=null;this.canvas.addEventListener("touchstart",s=>{if(s.touches.length===2){s.preventDefault();let i=s.touches[0].clientX-s.touches[1].clientX,n=s.touches[0].clientY-s.touches[1].clientY;t=Math.hypot(i,n),e={x:(s.touches[0].clientX+s.touches[1].clientX)/2,y:(s.touches[0].clientY+s.touches[1].clientY)/2}}},{passive:!1}),this.canvas.addEventListener("touchmove",s=>{if(s.touches.length===2){s.preventDefault();let i=s.touches[0].clientX-s.touches[1].clientX,n=s.touches[0].clientY-s.touches[1].clientY,l=Math.hypot(i,n),h={x:(s.touches[0].clientX+s.touches[1].clientX)/2,y:(s.touches[0].clientY+s.touches[1].clientY)/2};if(t>0){let c=this.canvas.getBoundingClientRect(),u=l/t,p=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*u));if(p!==this.zoom){let x=h.x-c.left,I=h.y-c.top,M=p/this.zoom;this.panX=x-(x-this.panX)*M,this.panY=I-(I-this.panY)*M,this.zoom=p}e&&(this.panX+=h.x-e.x,this.panY+=h.y-e.y),this._applyTransform()}t=l,e=h}},{passive:!1}),this.canvas.addEventListener("touchend",()=>{t=0,e=null})}_applyTransform(){this.canvas.style.transform=`translate(${this.panX}px, ${this.panY}px) scale(${this.zoom})`,this.onZoomChange?.(this.zoom)}_updateMaxZoomForScreen(){let t=this.canvas.parentElement;if(!t)return;let e=t.getBoundingClientRect(),s=this.canvas.width,i=this.canvas.height,n=e.width-40,l=e.height-40,h=n/s,c=l/i;this.maxZoom=Math.max(1,Math.min(8,Math.min(h,c))),this.zoom>this.maxZoom&&(this.zoom=this.maxZoom,this._applyTransform())}_setupResizeHandler(){let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this._updateMaxZoomForScreen()},100)}),setTimeout(()=>this._updateMaxZoomForScreen(),100)}_setupContainerZoomIsolation(){let t=this.canvas.parentElement;this._isMouseOverCanvas=!1,t?.addEventListener("mouseenter",()=>{this._isMouseOverCanvas=!0}),t?.addEventListener("mouseleave",()=>{this._isMouseOverCanvas=!1}),document.addEventListener("wheel",e=>{if(!this._isMouseOverCanvas)return;e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let s=Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX;if(s===0)return;let i=this.canvas.getBoundingClientRect(),n=e.clientX-i.left,l=e.clientY-i.top,h=s>0?.9:1.1,c=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*h));if(c!==this.zoom){let u=c/this.zoom;this.panX=n-(n-this.panX)*u,this.panY=l-(l-this.panY)*u,this.zoom=c,this._applyTransform()}},{passive:!1,capture:!0})}_updateHoverPreview(t,e){this.hoverX!==null&&this.hoverY!==null&&this._renderPixel(this.hoverX,this.hoverY,this.pixels[this.hoverY][this.hoverX]),this.hoverX=t,this.hoverY=e,this.isAuthorized&&t!==null&&e!==null&&this._renderHoverPreview(t,e)}_clearHoverPreview(){this.hoverX!==null&&this.hoverY!==null&&this._renderPixel(this.hoverX,this.hoverY,this.pixels[this.hoverY][this.hoverX]),this.hoverX=null,this.hoverY=null}_renderHoverPreview(t,e){let s=this.eraserMode?null:this.selectedColor,i=t*this.pixelSize,n=e*this.pixelSize;this.ctx.fillStyle=s||"#ffffff",this.ctx.fillRect(i,n,this.pixelSize,this.pixelSize),this.ctx.strokeStyle=this.eraserMode?"#ff0000":"#000000",this.ctx.lineWidth=2,this.ctx.strokeRect(i+1,n+1,this.pixelSize-2,this.pixelSize-2),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=1,this.ctx.strokeRect(i+2,n+2,this.pixelSize-4,this.pixelSize-4)}resetZoom(){this.zoom=1,this.panX=0,this.panY=0,this._applyTransform()}cycleZoom(){let t=[1,2,4],e=t.findIndex(s=>Math.abs(this.zoom-s)<.1);if(e===-1||e===t.length-1)this.zoom=1,this.panX=0,this.panY=0;else{let s=t[e+1],i=this.canvas.getBoundingClientRect(),n=i.width/2,l=i.height/2,h=s/this.zoom;this.panX=n-(n-this.panX)*h,this.panY=l-(l-this.panY)*h,this.zoom=s}this._applyTransform()}handleRemotePixel(t,e,s){t<0||t>=this.gridWidth||e<0||e>=this.gridHeight||(this.pixels[e][t]=s,this._renderPixel(t,e,s))}_renderPixel(t,e,s){this.ctx.fillStyle=s||"#ffffff",this.ctx.fillRect(t*this.pixelSize,e*this.pixelSize,this.pixelSize,this.pixelSize)}_render(){this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.gridHeight;t++)for(let e=0;e<this.gridWidth;e++)this.pixels[t][e]&&this._renderPixel(e,t,this.pixels[t][e])}setColor(t){L(t)&&a.PALETTE.includes(t)&&(this.selectedColor=t,this.hoverX!==null&&this.hoverY!==null&&this._updateHoverPreview(this.hoverX,this.hoverY))}setAuthorized(t){this.isAuthorized=t,this.canvas.style.cursor=t?"crosshair":"not-allowed",t||this._clearHoverPreview()}setEraserMode(t){this.eraserMode=t,this.hoverX!==null&&this.hoverY!==null&&this._updateHoverPreview(this.hoverX,this.hoverY)}clear(){this.pixels=this._createGrid(),this._render(),this._saveToStorage()}_saveToStorage(){let t=[];for(let e=0;e<this.gridHeight;e++)for(let s=0;s<this.gridWidth;s++)this.pixels[e][s]&&t.push({x:s,y:e,color:this.pixels[e][s]});try{localStorage.setItem(a.STORAGE_KEY,JSON.stringify({pixels:t}))}catch{}}loadFromArray(t){this.pixels=this._createGrid();for(let{x:e,y:s,color:i}of t)e>=0&&e<this.gridWidth&&s>=0&&s<this.gridHeight&&(this.pixels[s][e]=i);this._render()}loadFromStorage(){try{let t=localStorage.getItem(a.STORAGE_KEY);if(t)return this.loadFromArray(JSON.parse(t).pixels||[]),!0}catch{}return!1}};var k=class{constructor(){this.wallet=new E,this.canvas=null,this.isAuthorized=!1,this.isAdmin=!1,this.eraserMode=!1,this.backendAvailable=!1,this.canvasStatus={pixelCount:0,totalSlots:0,isFull:!1,clearAt:null},this.countdownInterval=null,this.el={connectBtn:document.getElementById("connect-btn"),disconnectBtn:document.getElementById("disconnect-btn"),statusText:document.getElementById("status-text"),walletStatus:document.getElementById("wallet-status"),walletDropdown:document.getElementById("wallet-dropdown"),networkBadge:document.getElementById("network-badge"),networkName:document.getElementById("network-name"),networkModal:document.getElementById("network-modal"),networkOptions:document.getElementById("network-options"),closeModalBtn:document.getElementById("close-modal-btn"),walletModal:document.getElementById("wallet-modal"),walletOptions:document.getElementById("wallet-options"),closeWalletModalBtn:document.getElementById("close-wallet-modal-btn"),authBanner:document.getElementById("auth-banner"),authMessage:document.getElementById("auth-message"),canvasOverlay:document.getElementById("canvas-overlay"),canvasElement:document.getElementById("pixel-canvas"),palette:document.getElementById("palette"),cursorCoords:document.getElementById("cursor-coords"),canvasSize:document.getElementById("canvas-size"),pixelCount:document.getElementById("pixel-count"),eraserSection:document.getElementById("eraser-section"),eraserBtn:document.getElementById("eraser-btn"),zoomDisplay:document.getElementById("zoom-display"),zoomLevel:document.getElementById("zoom-level")},this._init()}async _init(){await this._loadConfig(),this.canvas=new P(this.el.canvasElement,a.CANVAS),await this._loadCanvas(),this.el.canvasSize.textContent=`${a.CANVAS.width} \xD7 ${a.CANVAS.height}`,this._setupPalette(),this.canvas.onCursorMove=(t,e)=>{this.el.cursorCoords.textContent=t!==null?`${t}, ${e}`:"\u2014"},this.canvas.onPixelPlace=(t,e,s)=>{this._updatePixelCounter(),r.sendPixel(t,e,s)},this.canvas.onZoomChange=t=>{this._updateZoomDisplay(t)},this._updatePixelCounter(),this.wallet.onConnect=(t,e)=>this._handleConnect(t,e),this.wallet.onDisconnect=()=>this._handleDisconnect(),this.wallet.onAccountChange=t=>this._handleAccountChange(t),this.wallet.onChainChange=t=>this._handleChainChange(t),this._setupEvents(),this._buildNetworkOptions(),this._setupWebSocket(),await this.wallet.tryRehydrate(),await this._checkAuth(),this._updateUI()}async _loadConfig(){if(a.USE_BACKEND)try{let t=await C.getConfig();Object.assign(a.CANVAS,{width:t.width,height:t.height}),a.PALETTE=t.palette,this.backendAvailable=!0}catch(t){d.warn("App","Backend unavailable:",t.message)}}async _loadCanvas(){if(a.USE_BACKEND&&this.backendAvailable)try{let t=await C.getCanvas();this.canvas.loadFromArray(t.pixels||[]);return}catch{}this.canvas.loadFromStorage()}async _checkAuth(){let t=_();if(t)try{let e=await y.verify();this.isAuthorized=e.isAuthorized,this.isAdmin=e.isAdmin||!1,r.setToken(t)}catch{m(),r.setToken(null)}}_setupWebSocket(){a.USE_BACKEND&&(r.on("pixel",t=>{this.canvas.handleRemotePixel(t.x,t.y,t.color),this._updatePixelCounter()}),r.on("batch",t=>{t.forEach(e=>this.canvas.handleRemotePixel(e.x,e.y,e.color)),this._updatePixelCounter()}),r.on("status",t=>this._updateCanvasStatus(t)),r.on("cleared",()=>{this.canvas.clear(),this._updateCanvasStatus({pixelCount:0,isFull:!1,clearAt:null}),this._notify("\u2728 Canvas cleared!")}),r.on("connected",()=>{this._updateConnectionStatus("connected"),this.wallet.address&&r.setAddress(this.wallet.address),this._refreshCanvas()}),r.on("disconnected",()=>this._updateConnectionStatus("disconnected")),r.on("error",t=>{t.code==="AUTH_REQUIRED"&&this._notify("\u26A0\uFE0F Sign in to save pixels","warn")}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&!r.isConnected()&&r.connect()}),r.setOpenMode(a.OPEN_MODE||!1),this._updateConnectionStatus("connecting"),r.connect())}async _refreshCanvas(){if(!(!a.USE_BACKEND||!this.backendAvailable))try{let t=await C.getCanvas();t.pixels&&t.pixels.length>0&&this.canvas.loadFromArray(t.pixels),this._updateCanvasStatus({pixelCount:t.pixelCount||0,totalSlots:t.totalSlots,isFull:t.isFull,clearAt:t.clearAt})}catch{}}_updateConnectionStatus(t){let e=document.getElementById("status-dot"),s=document.getElementById("ws-status-text");!e||!s||(e.className="status-dot "+t,s.textContent={connected:"Live",disconnected:"Offline",connecting:"Connecting...",error:"Error"}[t]||"Offline")}_setupPalette(){this.el.palette.innerHTML="",a.PALETTE.forEach((t,e)=>{let s=document.createElement("button");s.className="palette-btn"+(e===0?" selected":""),s.style.backgroundColor=t,s.dataset.color=t,s.title=`Press ${e+1}`,s.onclick=()=>this._selectColor(t,s),this.el.palette.appendChild(s)})}_selectColor(t,e){this.canvas.setColor(t),this.el.palette.querySelectorAll(".palette-btn").forEach(s=>s.classList.remove("selected")),(e||this.el.palette.querySelector(`[data-color="${t}"]`))?.classList.add("selected")}_setupEvents(){this.el.connectBtn.onclick=()=>this._showWalletOptions(),this.el.disconnectBtn.onclick=()=>this._disconnect(),this.el.statusText.onclick=t=>{this.wallet.isConnected()&&(t.stopPropagation(),this.el.walletDropdown.classList.toggle("hidden"))},document.addEventListener("click",t=>{this.el.walletStatus.contains(t.target)||this.el.walletDropdown.classList.add("hidden")}),this.el.closeModalBtn?.addEventListener("click",()=>this.el.networkModal.classList.add("hidden")),this.el.networkModal?.addEventListener("click",t=>{t.target===this.el.networkModal&&this.el.networkModal.classList.add("hidden")}),this.el.closeWalletModalBtn?.addEventListener("click",()=>this.el.walletModal.classList.add("hidden")),this.el.walletModal?.addEventListener("click",t=>{t.target===this.el.walletModal&&this.el.walletModal.classList.add("hidden")}),document.addEventListener("keydown",t=>{if(t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA")return;let e=parseInt(t.key);e>=1&&e<=a.PALETTE.length&&(this._disableEraser(),this._selectColor(a.PALETTE[e-1])),t.key.toLowerCase()==="e"&&this.isAdmin&&this._toggleEraser(),t.key==="Escape"&&(this.el.networkModal.classList.add("hidden"),this.el.walletModal?.classList.add("hidden"))}),this.el.eraserBtn?.addEventListener("click",()=>this._toggleEraser()),this.el.zoomDisplay?.addEventListener("click",()=>this.canvas.cycleZoom()),window.addEventListener("auth:expired",()=>{this.isAuthorized=this.isAdmin=!1,this._updateUI()})}_toggleEraser(){this.isAdmin&&(this.eraserMode=!this.eraserMode,this.canvas.setEraserMode(this.eraserMode),this.el.eraserBtn?.classList.toggle("active",this.eraserMode),this.eraserMode&&this.el.palette.querySelectorAll(".palette-btn").forEach(t=>t.classList.remove("selected")),this.el.canvasElement.style.cursor=this.eraserMode?"cell":"crosshair")}_disableEraser(){this.eraserMode&&(this.eraserMode=!1,this.canvas.setEraserMode(!1),this.el.eraserBtn?.classList.remove("active"),this.el.canvasElement.style.cursor="crosshair")}_buildNetworkOptions(){this.el.networkOptions.innerHTML="",a.ALLOWED_CHAINS.forEach(t=>{let e=document.createElement("button");e.className="network-option-btn",e.textContent=t.name,e.onclick=async()=>{try{await this.wallet.switchNetwork(t.chainId),this.el.networkModal.classList.add("hidden")}catch(s){alert(`Failed: ${s.message}`)}},this.el.networkOptions.appendChild(e)})}async _showWalletOptions(){this.wallet.refreshWallets();let t=this.wallet.getAvailableWallets();if(!t.length){alert("No wallet detected. Install MetaMask or another wallet.");return}if(t.length===1){await this._connectWallet(t[0].uuid);return}if(!this.el.walletModal){await this._connectWallet(t[0].uuid);return}this.el.walletOptions.innerHTML="",t.forEach(e=>{let s=document.createElement("button");if(s.className="wallet-option-btn",e.icon){let i=document.createElement("img");i.src=e.icon,i.className="wallet-icon",i.onerror=()=>i.style.display="none",s.appendChild(i)}s.appendChild(Object.assign(document.createElement("span"),{textContent:e.name})),s.onclick=async()=>{this.el.walletModal.classList.add("hidden"),await this._connectWallet(e.uuid)},this.el.walletOptions.appendChild(s)}),this.el.walletModal.classList.remove("hidden")}async _connectWallet(t){try{await this.wallet.connect(t)}catch(e){e.message?.includes("rejected")||alert(`Connection failed: ${e.message}`)}}async _disconnect(){this.el.walletDropdown.classList.add("hidden"),await this.wallet.disconnect()}async _handleConnect(t,e){if(w(e)||this.el.networkModal.classList.remove("hidden"),a.USE_BACKEND&&this.backendAvailable)try{let s=await y.connect(t,e);this.isAuthorized=s.isAuthorized,this.isAdmin=s.isAdmin||!1;let i=_();i&&r.setToken(i)}catch(s){d.warn("App","Auth failed:",s.message),this.isAuthorized=a.OPEN_MODE}else this.isAuthorized=a.OPEN_MODE;r.setAddress(t),this._updateUI()}_handleDisconnect(){this.isAuthorized=this.isAdmin=!1,r.setAddress(null),r.setToken(null),m(),this._updateUI()}async _handleAccountChange(t){if(r.setAddress(t),a.USE_BACKEND&&this.backendAvailable)try{let e=await y.connect(t,this.wallet.chainId);this.isAuthorized=e.isAuthorized,this.isAdmin=e.isAdmin||!1}catch{}this._updateUI()}async _handleChainChange(t){if(!w(t))this.el.networkModal.classList.remove("hidden"),this.isAuthorized=!1;else if(this.el.networkModal.classList.add("hidden"),a.USE_BACKEND&&this.backendAvailable)try{let e=await y.refresh(t);this.isAuthorized=e.isAuthorized,this.isAdmin=e.isAdmin||!1;let s=_();s&&r.setToken(s)}catch{this.isAuthorized=a.OPEN_MODE}this._updateUI()}_updateUI(){let t=this.wallet.isConnected(),e=this.wallet.address,s=this.wallet.chainId,i=a.OPEN_MODE||!1;if(this.el.connectBtn.classList.toggle("hidden",t),t||this.el.walletDropdown.classList.add("hidden"),t?(this.el.statusText.innerHTML=`<span class="address">${b(e)}</span>`,this.el.walletStatus.classList.add("connected")):(this.el.statusText.textContent=i?"Open Canvas":"REMI Community Only",this.el.walletStatus.classList.remove("connected")),t&&s){let l=f(s);this.el.networkBadge.classList.remove("hidden"),this.el.networkBadge.classList.toggle("error",!l),this.el.networkName.textContent=l?.name||`Chain ${s}`}else this.el.networkBadge.classList.add("hidden");t?i?this.el.authBanner.classList.add("hidden"):(this.el.authBanner.classList.remove("hidden"),w(s)?this.isAuthorized?(this.el.authBanner.className="auth-banner authorized",this.el.authMessage.textContent="\u2713 NFT holders can draw"):(this.el.authBanner.className="auth-banner view-only",this.el.authMessage.textContent="\u{1F440} View only - need eligible NFT"):(this.el.authBanner.className="auth-banner view-only",this.el.authMessage.textContent="\u26A0\uFE0F Wrong network - please switch")):(this.el.authBanner.classList.remove("hidden"),this.el.authBanner.className="auth-banner view-only",this.el.authMessage.textContent="Connect wallet to draw");let n=i||t&&this.isAuthorized&&w(s);this.el.canvasOverlay.classList.toggle("hidden",n),this.canvas.setAuthorized(n),this.el.eraserSection?.classList.toggle("hidden",!this.isAdmin),!this.isAdmin&&this.eraserMode&&this._disableEraser()}_updatePixelCounter(){let t=0;for(let e=0;e<this.canvas.gridHeight;e++)for(let s=0;s<this.canvas.gridWidth;s++)this.canvas.pixels[e][s]&&t++;this.el.pixelCount.textContent=t.toLocaleString(),this.canvasStatus.pixelCount=t}_updateZoomDisplay(t){if(!this.el.zoomLevel)return;let e=t>=1?`${Math.round(t)}\xD7`:`${t.toFixed(1)}\xD7`;this.el.zoomLevel.textContent=e,this.el.zoomDisplay?.classList.toggle("zoomed",t!==1)}_updateCanvasStatus(t){Object.assign(this.canvasStatus,t),this._updatePixelCounter(),this.canvasStatus.isFull&&this.canvasStatus.clearAt?this._startCountdown():this._stopCountdown(),document.getElementById("canvas-full-status")?.classList.toggle("hidden",!this.canvasStatus.isFull)}_startCountdown(){this._stopCountdown();let t=()=>{if(!this.canvasStatus.clearAt)return;let e=Math.max(0,this.canvasStatus.clearAt-Date.now()),s=document.getElementById("countdown-timer");if(s)if(e>0){let i=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);s.textContent=`Clears in ${i}:${n.toString().padStart(2,"0")}`,s.classList.remove("hidden")}else s.classList.add("hidden")};t(),this.countdownInterval=setInterval(t,1e3)}_stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null),document.getElementById("countdown-timer")?.classList.add("hidden")}_notify(t,e="success"){let s=document.createElement("div");s.className=e==="warn"?"pixel-error-notification":"clear-notification",s.innerHTML=`<span>${t}</span>`,document.body.appendChild(s),setTimeout(()=>s.classList.add("visible"),10),setTimeout(()=>{s.classList.remove("visible"),setTimeout(()=>s.remove(),300)},4e3)}};document.addEventListener("DOMContentLoaded",()=>{window.app=new k});
